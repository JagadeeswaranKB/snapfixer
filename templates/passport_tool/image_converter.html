{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}
{% block meta_description %}{{ meta_description }}{% endblock %}

{% block og_title %}{{ title }}{% endblock %}
{% block og_description %}{{ meta_description }}{% endblock %}

{% block twitter_title %}{{ title }}{% endblock %}
{% block twitter_description %}{{ meta_description }}{% endblock %}

{% block schema %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "SnapFixer - Image Converter & Resizer",
  "applicationCategory": "Photography",
  "operatingSystem": "Web",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "INR"
  },
  "description": "{{ meta_description|escapejs }}",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.8",
    "reviewCount": "850"
  }
}
</script>

<!-- Breadcrumb Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://validphoto.com/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Image Converter",
      "item": "https://validphoto.com/compress-image-20kb/"
    }
  ]
}
</script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    <nav class="mb-4 text-xs text-gray-500 dark:text-gray-400">
        <a href="/" class="hover:text-blue-600">Home</a> /
        <span class="text-gray-900 dark:text-white font-medium">Image Converter</span>
    </nav>

    <div class="mb-8">
        <a href="/" class="text-blue-600 hover:text-blue-800 font-bold flex items-center gap-2 transition w-fit">
            <i class="fas fa-arrow-left"></i> Back to Home
        </a>
    </div>

    <!-- Main Tool Container -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Editor Column -->
        <div class="lg:col-span-8 space-y-6">
            <h1 class="text-3xl font-black text-gray-900 mb-2 dark:text-white">{{ h1 }}</h1>
            <p class="text-gray-500 mb-6 dark:text-gray-400">{{ intro_text }}</p>

            <!-- Canvas Area -->
            <div id="canvas-wrapper"
                class="relative w-full aspect-[4/3] bg-gray-100 rounded-2xl overflow-hidden shadow-inner border-4 border-dashed border-gray-300 flex items-center justify-center cursor-grab active:cursor-grabbing dark:bg-gray-800 dark:border-gray-700">
                <!-- Upload State -->
                <div id="upload-container" class="text-center p-8">
                    {% csrf_token %}

                    <div
                        class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 dark:bg-blue-900/30 dark:text-blue-400">
                        <i class="fas fa-cloud-upload-alt text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2 dark:text-white">Upload Image to Convert</h3>
                    <p class="text-sm text-gray-500 mb-6 max-w-xs mx-auto dark:text-gray-400">Supports JPG, PNG, WEBP,
                        HEIC.
                        Max 30MB.</p>
                    <label
                        class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition cursor-pointer shadow-lg hover:shadow-blue-500/30 inline-flex items-center gap-2 w-full justify-center md:w-auto">
                        <i class="fas fa-image"></i> Select Photo
                        <input type="file" id="photo-input" class="hidden" accept="image/*">
                    </label>
                </div>

                <!-- Processing State -->
                <div id="progress-container" class="hidden text-center w-full max-w-md px-4">
                    <div class="relative w-24 h-24 mx-auto mb-8">
                        <div class="absolute inset-0 border-4 border-gray-200 rounded-full dark:border-gray-700"></div>
                        <div
                            class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin">
                        </div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="progress-percent" class="text-lg font-bold text-blue-600">0%</span>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2 dark:text-white">Processing Image</h3>
                    <p id="status-text" class="text-gray-500 text-sm mb-4 dark:text-gray-400">Analyzing...</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden dark:bg-gray-700">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300 w-0">
                        </div>
                    </div>
                    <p id="est-time" class="text-xs text-gray-400 mt-2 font-mono">Estimated time: ~15 seconds</p>
                </div>

                <!-- Editor State -->
                <div id="result-container" class="hidden w-full h-full relative flex items-center justify-center">
                    <canvas id="editor-canvas" class="max-w-full max-h-full shadow-lg"></canvas>
                </div>
            </div>

            <!-- Guidelines/Tips (Simplified) -->
            <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 dark:bg-blue-900/10 dark:border-blue-900/30">
                <h4 class="font-bold text-blue-900 mb-3 flex items-center gap-2 dark:text-blue-300">
                    <i class="fas fa-info-circle text-blue-500"></i> Features
                </h4>
                <ul class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-blue-800 dark:text-blue-200">
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check-circle text-blue-500 mt-0.5"></i>
                        <span>Convert between JPG, PNG, WEBP</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check-circle text-blue-500 mt-0.5"></i>
                        <span>Resize to exact millimeter dimensions</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check-circle text-blue-500 mt-0.5"></i>
                        <span>Optional AI Background Removal</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check-circle text-blue-500 mt-0.5"></i>
                        <span>Target specific file sizes (KB)</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Sidebar Controls -->
        <div class="lg:col-span-4">
            <div
                class="bg-white rounded-2xl shadow-lg border border-gray-100 sticky top-8 dark:bg-gray-800 dark:border-gray-700">
                <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                    <h3 class="font-bold text-gray-900 flex items-center gap-2 dark:text-white">
                        <i class="fas fa-sliders-h text-blue-600"></i> Converter Settings
                    </h3>
                </div>

                <div class="p-6 space-y-8">
                    <!-- Background Color -->
                    <div>
                        <label
                            class="block text-sm font-bold text-gray-700 uppercase tracking-wider mb-4 dark:text-gray-300">Background</label>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="changeBg('#FFFFFF')"
                                class="w-10 h-10 rounded-full border-2 border-gray-200 shadow-md hover:scale-110 transition bg-white"
                                title="White"></button>
                            <button onclick="changeBg('transparent')"
                                class="w-10 h-10 rounded-full border-2 border-white shadow-md hover:scale-110 transition bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-gray-200"
                                title="Transparent (No Background)"></button>

                            <div
                                class="relative w-10 h-10 rounded-full border-2 border-white shadow-md overflow-hidden bg-[conic-gradient(from_0deg,#ff0000,#ffff00,#00ff00,#00ffff,#0000ff,#ff00ff,#ff0000)] items-center justify-center flex hover:scale-110 transition">
                                <input type="color" id="bg-picker" onchange="changeBg(this.value)"
                                    class="absolute scale-[3] cursor-pointer opacity-0">
                                <i class="fas fa-plus text-white drop-shadow-md pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Magic Eraser -->
                    <div>
                        <label
                            class="block text-sm font-bold text-gray-700 uppercase tracking-wider mb-4 dark:text-gray-300">
                            Touch Up
                        </label>
                        <button id="eraser-btn" onclick="toggleEraser()"
                            class="w-full bg-white border border-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-50 hover:text-blue-600 transition flex items-center justify-center gap-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                            <i class="fas fa-eraser text-gray-400"></i> Magic Eraser
                        </button>

                        <div id="eraser-controls"
                            class="hidden mt-4 p-4 bg-gray-50 rounded-xl border border-gray-100 space-y-4 dark:bg-gray-700/50 dark:border-gray-600">
                            <div>
                                <div
                                    class="flex justify-between text-xs font-bold text-gray-500 mb-2 dark:text-gray-400">
                                    <span>Brush Size</span>
                                    <span id="brush-size-val">20px</span>
                                </div>
                                <input type="range" min="5" max="100" value="20" class="w-full accent-blue-600"
                                    oninput="setBrushSize(this.value)">
                            </div>

                            <div class="flex gap-2">
                                <button id="undo-btn" onclick="undoEraser()" disabled
                                    class="flex-1 bg-white border border-gray-200 py-2 rounded-lg text-gray-600 hover:text-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300">
                                    <i class="fas fa-undo"></i> Undo
                                </button>
                                <button id="redo-btn" onclick="redoEraser()" disabled
                                    class="flex-1 bg-white border border-gray-200 py-2 rounded-lg text-gray-600 hover:text-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300">
                                    <i class="fas fa-redo"></i> Redo
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Dimensions -->
                    <div
                        class="p-4 bg-blue-50 border border-blue-100 rounded-xl space-y-4 dark:bg-indigo-900/20 dark:border-indigo-800">
                        <label
                            class="block text-xs font-bold text-blue-700 uppercase tracking-widest dark:text-blue-300">
                            Dimensions <span class="text-[10px] normal-case text-gray-500 ml-1">(Auto-detected)</span>
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Width -->
                            <div>
                                <span
                                    class="text-[10px] text-blue-400 font-bold uppercase block mb-1 dark:text-blue-500">Width</span>
                                <div
                                    class="flex items-center bg-white rounded-lg border border-blue-200 overflow-hidden shadow-sm dark:bg-gray-800 dark:border-gray-700">
                                    <button type="button" onclick="adjustDimension('custom-width', -1)"
                                        class="px-2 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 transition border-r border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600">
                                        <i class="fas fa-minus text-[10px]"></i>
                                    </button>
                                    <input type="number" id="custom-width" value="{{ country_rule.width_mm }}"
                                        oninput="applyCustomDimensions()"
                                        class="w-full text-center text-sm font-bold text-blue-900 outline-none border-none bg-transparent [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none dark:text-white">
                                    <button type="button" onclick="adjustDimension('custom-width', 1)"
                                        class="px-2 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 transition border-l border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600">
                                        <i class="fas fa-plus text-[10px]"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- Height -->
                            <div>
                                <span
                                    class="text-[10px] text-blue-400 font-bold uppercase block mb-1 dark:text-blue-500">Height</span>
                                <div
                                    class="flex items-center bg-white rounded-lg border border-blue-200 overflow-hidden shadow-sm dark:bg-gray-800 dark:border-gray-700">
                                    <button type="button" onclick="adjustDimension('custom-height', -1)"
                                        class="px-2 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 transition border-r border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600">
                                        <i class="fas fa-minus text-[10px]"></i>
                                    </button>
                                    <input type="number" id="custom-height" value="{{ country_rule.height_mm }}"
                                        oninput="applyCustomDimensions()"
                                        class="w-full text-center text-sm font-bold text-blue-900 outline-none border-none bg-transparent [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none dark:text-white">
                                    <button type="button" onclick="adjustDimension('custom-height', 1)"
                                        class="px-2 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 transition border-l border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600">
                                        <i class="fas fa-plus text-[10px]"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="resetToOriginalSize()"
                                class="flex-1 bg-white border border-gray-200 text-gray-600 py-2 rounded-lg text-xs font-bold hover:bg-gray-50 transition flex items-center justify-center gap-1 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <button onclick="applyCustomDimensions()"
                                class="flex-[2] bg-blue-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition">
                                Apply New Size
                            </button>
                        </div>
                    </div>

                    <!-- Fine-Tune Controls -->
                    <div class="space-y-6">
                        <div
                            class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-4 dark:bg-indigo-900/20 dark:border-indigo-800">
                            <div class="flex justify-between items-center h-5">
                                <span class="text-xs font-bold text-blue-700 uppercase dark:text-blue-300">Current
                                    Size:</span>
                                <span id="file-size-display"
                                    class="text-sm font-black text-blue-800 dark:text-white">Calculating...</span>
                            </div>

                            <div class="pt-2 border-t border-blue-100/50 flex flex-col gap-3">
                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-blue-600 uppercase tracking-wider mb-2 dark:text-blue-400">Save
                                        Filename As</label>
                                    <div
                                        class="flex items-center bg-white rounded-lg border border-blue-200 overflow-hidden shadow-sm dark:bg-gray-800 dark:border-gray-700">
                                        <div
                                            class="px-3 py-2 bg-blue-50 text-blue-400 border-r border-blue-100 dark:bg-gray-700 dark:text-blue-500 dark:border-gray-600">
                                            <i class="fas fa-file-signature text-xs"></i>
                                        </div>
                                        <input type="text" id="save-filename" value="converted_image"
                                            class="flex-grow px-3 py-2 text-sm font-bold text-blue-900 outline-none border-none bg-transparent min-w-0 dark:text-white"
                                            placeholder="Enter filename...">
                                        <span id="filename-ext"
                                            class="text-[10px] font-black text-blue-100 bg-blue-600 px-3 py-1 flex items-center justify-center min-w-[50px] self-stretch">.jpg</span>
                                    </div>
                                </div>

                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-blue-600 uppercase tracking-wider mb-2 dark:text-blue-400">File
                                        Format</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button onclick="changeFormat('jpeg')" id="fmt-jpeg"
                                            class="fmt-btn active bg-blue-600 text-white py-1.5 rounded-lg text-xs font-bold transition dark:bg-blue-600 dark:text-white">JPG</button>
                                        <button onclick="changeFormat('png')" id="fmt-png"
                                            class="fmt-btn bg-white text-blue-600 border border-blue-200 py-1.5 rounded-lg text-xs font-bold transition hover:bg-blue-50 dark:bg-gray-800 dark:text-blue-400 dark:border-gray-700 dark:hover:bg-gray-700">PNG</button>
                                        <button onclick="changeFormat('webp')" id="fmt-webp"
                                            class="fmt-btn bg-white text-blue-600 border border-blue-200 py-1.5 rounded-lg text-xs font-bold transition hover:bg-blue-50 dark:bg-gray-800 dark:text-blue-400 dark:border-gray-700 dark:hover:bg-gray-700">WEBP</button>
                                    </div>
                                </div>

                                <div class="pt-2">
                                    <div class="flex justify-between mb-2 items-end">
                                        <label
                                            class="text-[10px] font-bold text-blue-600 uppercase tracking-widest dark:text-blue-400">Zoom
                                            Level</label>
                                        <span id="zoom-val"
                                            class="text-[10px] font-bold text-blue-700 bg-blue-50 px-2 py-0.5 rounded dark:bg-blue-900/30 dark:text-blue-300">100%</span>
                                    </div>
                                    <input type="range" id="zoom-slider" min="10" max="400" value="100"
                                        class="w-full h-1.5 bg-blue-100 rounded-lg appearance-none cursor-pointer accent-blue-600 dark:bg-gray-700">
                                </div>
                            </div>

                            <div class="pt-2 border-t border-blue-100/50 dark:border-indigo-800/50">
                                <label
                                    class="block text-[10px] font-bold text-blue-600 uppercase tracking-wider mb-2 dark:text-blue-400">Target
                                    Download Size</label>
                                <div
                                    class="flex items-center bg-white rounded-lg border border-blue-200 overflow-hidden shadow-sm dark:bg-gray-800 dark:border-gray-700">
                                    <button type="button" onclick="adjustTarget(-50)"
                                        class="px-3 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 active:bg-blue-200 transition border-r border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600">
                                        <i class="fas fa-minus text-xs"></i>
                                    </button>
                                    <div class="flex-grow flex items-center px-4">
                                        <input type="number" id="target-kb" value="350" min="50" max="2500"
                                            class="w-16 text-center text-sm font-black text-blue-900 outline-none border-none bg-transparent [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none dark:text-white">
                                        <span class="text-xs font-bold text-blue-400 ml-1 dark:text-blue-500">KB</span>
                                    </div>
                                    <button type="button" onclick="adjustTarget(50)"
                                        class="px-3 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 active:bg-blue-200 transition border-l border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600">
                                        <i class="fas fa-plus text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-8 border-t border-gray-100 flex flex-col gap-4">
                        <button onclick="downloadFinal(event)"
                            class="w-full bg-gradient-to-r from-emerald-500 to-green-600 text-white px-8 py-4 rounded-2xl font-bold text-lg hover:shadow-lg hover:shadow-green-200 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-3">
                            <i class="fas fa-arrow-down"></i> Download Converted Image
                        </button>
                        <button onclick="location.reload()"
                            class="w-full text-gray-500 font-semibold hover:text-blue-600 transition flex items-center justify-center gap-2">
                            <i class="fas fa-redo"></i> Start Over
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SEO Content Section -->
    <div
        class="mt-16 bg-white rounded-3xl shadow-sm p-8 md:p-12 border border-gray-100 dark:bg-gray-800 dark:border-gray-700">
        <h2 class="text-3xl font-bold text-gray-900 mb-8 dark:text-white text-center">Free Image Resizer & Converter
            Guide</h2>
        <div class="prose prose-blue max-w-none dark:prose-invert">
            {{ generated_seo_content|safe }}
        </div>
    </div>

    <!-- Background Option Modal -->
    <div id="bg-option-modal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform transition-all scale-100 dark:bg-gray-800 dark:border dark:border-gray-700">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 dark:bg-blue-900/30">
                    <i class="fas fa-magic text-2xl text-blue-600 dark:text-blue-400"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2 dark:text-white">Process Image?</h3>
                <p class="text-gray-500 text-sm dark:text-gray-400">
                    Do you want our AI to remove the background, or just convert the format/size?
                </p>
            </div>

            <div class="space-y-3">
                <button id="btn-remove-bg"
                    class="w-full bg-blue-600 text-white rounded-xl py-4 font-bold hover:bg-blue-700 hover:shadow-lg hover:-translate-y-0.5 transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-user-edit"></i> Remove Background
                </button>
                <div class="relative flex py-1 items-center">
                    <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-xs uppercase font-bold">Or</span>
                    <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
                </div>
                <button id="btn-keep-original"
                    class="w-full bg-white text-gray-700 border border-gray-200 rounded-xl py-3 font-bold hover:bg-gray-50 hover:text-blue-600 transition-all flex items-center justify-center gap-3 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600">
                    <i class="fas fa-image"></i> Keep Original Background
                </button>
            </div>
            <button id="btn-cancel-upload"
                class="mt-6 text-gray-400 text-xs font-bold hover:text-gray-600 block mx-auto transition dark:hover:text-gray-300">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
    // Global variables
    let canvas, ctx, img;
    let scale = 1.0;
    let posX = 0, posY = 0;
    let isDragging = false;
    let lastMouseX, lastMouseY;
    let bgColor = '#FFFFFF';
    let defaultWidthMm = null;
    let defaultHeightMm = null;
    let pendingFile = null;

    // Eraser Variables
    let isErasing = false;
    let brushSize = 20;
    let maskCanvas = document.createElement('canvas');
    let maskCtx = maskCanvas.getContext('2d');
    let eraserHistory = [];
    let eraserRedoStack = [];
    let isDrawingMask = false;
    let lastImgX = null, lastImgY = null;


    // --- File Input & Drag Drop (Existing Logic) ---


    document.getElementById('photo-input').addEventListener('change', function (e) {
        try {
            if (!e.target.files[0]) return;
            handleFile(e.target.files[0]);
        } catch (err) {
            console.error("Error in file input: " + err.message);
        }
    });

    const dropZone = document.getElementById('canvas-wrapper');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, highlight, false));
    ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, unhighlight, false));
    function highlight(e) { dropZone.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20'); dropZone.classList.remove('border-gray-300', 'bg-gray-100', 'dark:bg-gray-800'); }
    function unhighlight(e) { dropZone.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20'); dropZone.classList.add('border-gray-300', 'bg-gray-100', 'dark:bg-gray-800'); }
    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) handleFile(files[0]);
    }

    function handleFile(file) {
        const allowedExtensions = ['jpg', 'jpeg', 'png', 'webp', 'heic', 'heif'];
        const fileExt = file.name.split('.').pop().toLowerCase();

        if (file.size > 30 * 1024 * 1024) {
            alert("File too large. Maximum size is 30MB.");
            return;
        }

        if (file.type.startsWith('image/') || allowedExtensions.includes(fileExt)) {
            pendingFile = file;
            document.getElementById('bg-option-modal').classList.remove('hidden');
        } else { alert("Please drop an image file."); }
    }


    // --- Canvas Interaction (Panning & Eraser) ---
    const wrapper = document.getElementById('canvas-wrapper');

    wrapper.addEventListener('mousedown', (e) => {
        if (!img) return;
        isDragging = true;
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;

        if (isErasing) {
            isDrawingMask = true;
            saveEraserState();
            lastImgX = null;
            lastImgY = null;
            drawMask(e);
        }
    });

    wrapper.addEventListener('mousemove', (e) => {
        if (!img || !isDragging) return;

        if (isErasing) {
            if (isDrawingMask) drawMask(e);
        } else {
            const dx = e.clientX - lastMouseX;
            const dy = e.clientY - lastMouseY;

            // Sensitivity adjustment: dx is in screen pixels, posX is in canvas pixels
            // We need to account for the current scale and display size
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            posX += dx * scaleX;
            posY += dy * scaleY;

            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            draw();
        }
    });

    window.addEventListener('mouseup', () => {
        isDragging = false;
        isDrawingMask = false;
        lastImgX = null;
        lastImgY = null;
    });

    // Zoom Slider Listener
    document.getElementById('zoom-slider').addEventListener('input', (e) => {
        scale = parseFloat(e.target.value) / 100;
        document.getElementById('zoom-val').innerText = e.target.value + '%';
        draw();
    });


    // --- Eraser Functions ---
    function toggleEraser() {
        isErasing = !isErasing;
        const btn = document.getElementById('eraser-btn');
        const controls = document.getElementById('eraser-controls');

        if (isErasing) {
            btn.classList.add('bg-blue-50', 'border-blue-400', 'text-blue-600', 'ring-2', 'ring-blue-200');
            btn.innerHTML = '<i class="fas fa-check text-blue-500"></i> Done Erasing';
            controls.classList.remove('hidden');
            wrapper.style.cursor = 'crosshair';

            // Allow direct canvas access
            canvas.style.pointerEvents = 'auto';
        } else {
            btn.classList.remove('bg-blue-50', 'border-blue-400', 'text-blue-600', 'ring-2', 'ring-blue-200');
            btn.innerHTML = '<i class="fas fa-eraser text-gray-400"></i> Magic Eraser';
            controls.classList.add('hidden');
            wrapper.style.cursor = 'grab';
        }
    }

    function setBrushSize(val) {
        brushSize = parseInt(val);
        document.getElementById('brush-size-val').innerText = val + 'px';
    }

    function drawMask(e) {
        // Get the rect of the canvas itself, not the wrapper
        const rect = canvas.getBoundingClientRect();

        // Mouse relative to the canvas element
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // Calculate scale between displayed CSS pixels and internal Canvas pixels
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        // Map mouse to internal canvas coordinates
        // For eraser, we need to map to image space (accounting for posX, posY, scale)
        const imgX = (mouseX * scaleX - posX) / scale;
        const imgY = (mouseY * scaleY - posY) / scale;

        maskCtx.globalCompositeOperation = 'source-over';
        maskCtx.lineCap = 'round';
        maskCtx.lineJoin = 'round';
        // Brush size on canvas depends on scale
        maskCtx.lineWidth = (brushSize * scaleX) / scale;
        maskCtx.strokeStyle = 'black';
        maskCtx.fillStyle = 'black';

        maskCtx.beginPath();
        if (lastImgX !== null && lastImgY !== null) {
            maskCtx.moveTo(lastImgX, lastImgY);
            maskCtx.lineTo(imgX, imgY);
            maskCtx.stroke();
        } else {
            maskCtx.arc(imgX, imgY, ((brushSize * scaleX) / scale) / 2, 0, Math.PI * 2);
            maskCtx.fill();
        }

        lastImgX = imgX;
        lastImgY = imgY;
        draw();
    }

    // ... (saveEraserState, undoEraser, redoEraser, updateEraserButtons stay same) ...
    function saveEraserState() {
        if (eraserHistory.length >= 20) eraserHistory.shift();
        eraserHistory.push(maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height));
        eraserRedoStack = [];
        updateEraserButtons();
    }

    function undoEraser() {
        if (eraserHistory.length === 0) return;
        eraserRedoStack.push(maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height));
        const prevState = eraserHistory.pop();
        maskCtx.putImageData(prevState, 0, 0);
        draw();
        updateEraserButtons();
    }

    function redoEraser() {
        if (eraserRedoStack.length === 0) return;
        eraserHistory.push(maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height));
        const nextState = eraserRedoStack.pop();
        maskCtx.putImageData(nextState, 0, 0);
        draw();
        updateEraserButtons();
    }

    function updateEraserButtons() {
        document.getElementById('undo-btn').disabled = eraserHistory.length === 0;
        document.getElementById('redo-btn').disabled = eraserRedoStack.length === 0;
    }


    // --- Modal & Upload (Existing Logic) ---
    // ... (Keep existing logic unchanged) ...
    document.getElementById('btn-remove-bg').addEventListener('click', () => {
        document.getElementById('bg-option-modal').classList.add('hidden');
        if (pendingFile) startUpload(pendingFile, false);
    });
    document.getElementById('btn-keep-original').addEventListener('click', () => {
        document.getElementById('bg-option-modal').classList.add('hidden');
        if (pendingFile) startUpload(pendingFile, true);
    });
    document.getElementById('btn-cancel-upload').addEventListener('click', () => {
        document.getElementById('bg-option-modal').classList.add('hidden');
        document.getElementById('photo-input').value = '';
        pendingFile = null;
    });

    async function startUpload(file, skipBg) {
        try {

            console.log('startUpload called', file, skipBg);

            const formData = new FormData();
            formData.append('photo', file);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            formData.append('use_original_dimensions', 'true');
            if (skipBg) formData.append('skip_bg', 'true');

            document.getElementById('upload-container').classList.add('hidden');
            document.getElementById('progress-container').classList.remove('hidden');

            let progress = 0;
            const interval = setInterval(() => {
                if (progress < 90) {
                    progress += (progress < 60) ? 2 : 0.5;
                    updateProgress(Math.floor(progress), skipBg ? "Converting format..." : "AI Removing Background...");
                }
            }, 500);

            try {
                const response = await fetch('/api/upload/{{ country_rule.slug }}/', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.status === 'processing' || data.status === 'success') {
                    checkStatus(data.photo_id, interval);
                } else {
                    alert("Error: " + (data.error || "Upload failed"));
                    location.reload();
                }
            } catch (err) {
                alert("Upload Network Error: " + err.message);
                location.reload();
            }
        } catch (criticalErr) {
            console.error("Critical Error in startUpload: " + criticalErr.message);
            location.reload();
        }
    }

    // ... checkStatus, updateProgress (same as before) ...
    function updateProgress(percent, text) {
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-percent').innerText = percent + '%';
        if (text) document.getElementById('status-text').innerText = text;
        const timeEl = document.getElementById('est-time');
        if (percent < 30) timeEl.innerText = "Estimated time: ~12 seconds";
        else if (percent < 60) timeEl.innerText = "Estimated time: ~8 seconds";
        else if (percent < 80) timeEl.innerText = "Estimated time: ~5 seconds";
        else if (percent < 95) timeEl.innerText = "Almost there...";
        else if (percent >= 100) timeEl.innerText = "Done!";
    }

    async function checkStatus(photoId, interval) {
        try {
            const response = await fetch(`/api/status/${photoId}/`);
            if (!response.ok) throw new Error("Status check failed");
            const data = await response.json();

            if (data.status === 'completed') {
                clearInterval(interval);
                updateProgress(100, "Ready!");
                setTimeout(() => initEditor(data.processed_url), 500);
            } else if (data.status === 'failed') {
                clearInterval(interval);
                alert("Processing failed. Please try again.");
                location.reload();
            } else {
                setTimeout(() => checkStatus(photoId, interval), 2000);
            }
        } catch (err) {
            console.error("Polling error:", err);
            setTimeout(() => checkStatus(photoId, interval), 3000);
        }
    }

    // --- Editor Intialization & Drawing ---
    function initEditor(imgData) {
        document.getElementById('progress-container').classList.add('hidden');
        document.getElementById('result-container').classList.remove('hidden');

        canvas = document.getElementById('editor-canvas');
        ctx = canvas.getContext('2d');

        img = new Image();
        img.onload = () => {
            posX = 0; posY = 0; scale = 1.0;

            const imgWidthMm = (img.width * 25.4) / 300;
            const imgHeightMm = (img.height * 25.4) / 300;

            defaultWidthMm = imgWidthMm;
            defaultHeightMm = imgHeightMm;

            const wInput = document.getElementById('custom-width');
            const hInput = document.getElementById('custom-height');
            if (wInput && hInput) {
                wInput.value = imgWidthMm.toFixed(1);
                hInput.value = imgHeightMm.toFixed(1);
            }

            canvas.width = img.width;
            canvas.height = img.height;

            // Calculate display size to fit wrapper while preserving aspect ratio
            const wrapper = document.getElementById('canvas-wrapper');
            const wrapRect = wrapper.getBoundingClientRect();
            // Account for padding if any
            const availW = wrapRect.width - 4; // approximate border/padding
            const availH = wrapRect.height - 4;

            const scaleW = availW / img.width;
            const scaleH = availH / img.height;
            const fitScale = Math.min(scaleW, scaleH);

            // Set expliclit CSS size (optional, but max-w-full max-h-full handles most of it)
            // But for accurate coordinate mapping it's good to let browser layout handle it 
            // and we read getBoundingClientRect. 
            // The class modification max-w-full max-h-full should handle the fit.

            // Initialize Mask
            maskCanvas.width = img.width;
            maskCanvas.height = img.height;
            maskCtx = maskCanvas.getContext('2d');
            maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
            eraserHistory = [];
            eraserRedoStack = [];

            draw();
        };
        img.src = imgData;
    }

    function resetToOriginalSize() {
        if (defaultWidthMm !== null && defaultHeightMm !== null) {
            const wInput = document.getElementById('custom-width');
            const hInput = document.getElementById('custom-height');

            if (wInput && hInput) {
                wInput.value = defaultWidthMm.toFixed(1);
                hInput.value = defaultHeightMm.toFixed(1);
                applyCustomDimensions();
            }
        }
    }

    function applyCustomDimensions() {
        const wInput = document.getElementById('custom-width');
        const hInput = document.getElementById('custom-height');

        const wMm = parseFloat(wInput.value);
        const hMm = parseFloat(hInput.value);

        if (wMm > 0 && hMm > 0) {
            canvas.width = (wMm / 25.4) * 300;
            canvas.height = (hMm / 25.4) * 300;

            // Mask must also resize? Or just be cleared?
            // If we resize canvas, the mask should ideally be resized or cleared.
            // For simple implementation, let's clear it or create new.
            maskCanvas.width = canvas.width;
            maskCanvas.height = canvas.height;
            maskCtx = maskCanvas.getContext('2d');
            eraserHistory = []; // clear history on resize
            eraserRedoStack = [];

            draw();
        }
    }

    function adjustDimension(id, delta) {
        const input = document.getElementById(id);
        let val = parseInt(input.value) || 0;
        val += delta;
        if (val < 1) val = 1;
        input.value = val;
        applyCustomDimensions();
    }

    let currentFormat = 'jpeg';
    function changeFormat(fmt) {
        currentFormat = fmt;
        document.querySelectorAll('.fmt-btn').forEach(b => {
            b.classList.remove('active', 'bg-blue-600', 'text-white', 'dark:bg-blue-600', 'dark:text-white');
            b.classList.add('bg-white', 'text-blue-600', 'border', 'border-blue-200', 'dark:bg-gray-800', 'dark:text-blue-400', 'dark:border-gray-700');
        });
        const activeBtn = document.getElementById('fmt-' + fmt);
        if (activeBtn) {
            activeBtn.classList.add('active', 'bg-blue-600', 'text-white', 'dark:bg-blue-600', 'dark:text-white');
            activeBtn.classList.remove('bg-white', 'text-blue-600', 'border', 'border-blue-200', 'dark:bg-gray-800', 'dark:text-blue-400', 'dark:border-gray-700');
        }
        document.getElementById('filename-ext').innerText = '.' + (fmt === 'jpeg' ? 'jpg' : fmt);
        updateFileSize();
    }

    function changeBg(color) {
        bgColor = color;
        if (color === 'transparent' && currentFormat === 'jpeg') {
            changeFormat('png');
            alert("Switched to PNG to preserve transparency.");
        }
        draw();
    }

    function adjustTarget(delta) {
        const input = document.getElementById('target-kb');
        let val = parseInt(input.value) || 300;
        val += delta;
        if (val < 50) val = 50;
        input.value = val;
    }

    function draw() {
        if (!ctx || !img) return;

        // 1. Clear with BG
        if (bgColor === 'transparent') {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        } else {
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // 2. Temp Canvas for Image + Mask
        const tempC = document.createElement('canvas');
        tempC.width = img.width;
        tempC.height = img.height;
        const tCtx = tempC.getContext('2d');

        // Draw Image
        tCtx.drawImage(img, 0, 0);

        // Apply Eraser Mask (destination-out)
        tCtx.globalCompositeOperation = 'destination-out';
        tCtx.drawImage(maskCanvas, 0, 0);

        // 3. Draw result to main canvas
        // With 'source-over', this layers the masked image over the background color
        ctx.globalCompositeOperation = 'source-over';
        ctx.drawImage(tempC, posX, posY, img.width * scale, img.height * scale);

        updateFileSize();
    }

    // ... updateFileSize, downloadFinal (same as before) ...
    let fileSizeTimeout;
    function updateFileSize() {
        clearTimeout(fileSizeTimeout);
        fileSizeTimeout = setTimeout(() => {
            if (!canvas) return;
            const dataUrl = canvas.toDataURL('image/' + currentFormat, 0.95);
            const sizeInBytes = Math.round((dataUrl.length - ('data:image/' + currentFormat + ';base64,').length) * 3 / 4);
            const display = document.getElementById('file-size-display');
            if (display) display.innerText = `${(sizeInBytes / 1024).toFixed(1)} KB`;
        }, 500);
    }

    async function downloadFinal(event) {
        if (!canvas) return;
        const link = document.createElement('a');
        const userFilename = document.getElementById('save-filename').value.trim() || 'converted_image';
        const finalDataUrl = canvas.toDataURL('image/' + currentFormat, 0.98);
        link.download = `${userFilename}.${currentFormat === 'jpeg' ? 'jpg' : currentFormat}`;
        link.href = finalDataUrl;
        link.click();
    }
</script>
{% endblock %}
```
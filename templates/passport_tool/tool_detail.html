{% extends 'base.html' %}
{% load static %}

{% block schema %}
<!-- Structured Data: SoftwareApplication -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "SnapFixer - {{ country_rule.country }} Tool",
  "applicationCategory": "Photography",
  "operatingSystem": "Web",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "INR"
  },
  "description": "{{ meta_description|escapejs }}",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.9",
    "reviewCount": "1250"
  }
}
</script>

<!-- Breadcrumb Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://validphoto.com/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "{{ country_rule.country }} Photo Tool",
      "item": "{{ request.build_absolute_uri }}"
    }
  ]
}
</script>
{% endblock %}

{% block content %}
<!-- Fabric.js for Clothing Overlay -->
<script src="{% static 'js/fabric.min.js' %}"></script>
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    <nav class="mb-4 text-xs text-gray-500 dark:text-gray-400">
        <a href="/" class="hover:text-blue-600">Home</a> /
        {% if country_rule.is_exam %}
        <span class="hover:text-blue-600">Exams</span> /
        {% elif country_rule.is_visa %}
        <span class="hover:text-blue-600">Visas</span> /
        {% elif country_rule.is_tool %}
        <span class="hover:text-blue-600">Tools</span> /
        {% else %}
        <span class="hover:text-blue-600">Passports</span> /
        {% endif %}
        <span class="text-gray-900 dark:text-white font-medium">{{ country_rule.country }}</span>
    </nav>

    <div class="mb-8">
        <a href="/" class="text-blue-600 hover:text-blue-800 font-bold flex items-center gap-2 transition w-fit">
            <i class="fas fa-arrow-left"></i> Back to Home
        </a>
    </div>

    <!-- Dynamic SEO Header -->
    <div class="mb-12 text-center max-w-4xl mx-auto animate-fade-in-up">
        <h1 class="text-3xl md:text-4xl font-black text-gray-900 mb-4 dark:text-white">{{ h1 }}</h1>
        <p class="text-base text-gray-600 dark:text-gray-400 leading-relaxed max-w-2xl mx-auto">{{ intro_text }}</p>
    </div>

    <!-- Main Tool Container: Split Layout for Desktop -->
    <div class="lg:grid lg:grid-cols-12 lg:gap-8 items-start">

        <!-- Left Column (Preview/Canvas) - Ordered first for both mobile and desktop -->
        <div class="lg:col-span-7 xl:col-span-8 lg:order-1 space-y-6 mb-8 lg:mb-0">
            <!-- Canvas Area -->
            <div id="canvas-wrapper"
                class="relative w-full h-[450px] md:h-[600px] bg-gray-200 rounded-2xl overflow-hidden shadow-inner border-4 border-dashed border-gray-300 flex items-center justify-center cursor-grab active:cursor-grabbing dark:bg-gray-700/50 dark:border-gray-600">
                <!-- Upload State -->
                <div id="upload-container" class="text-center p-8">
                    {% csrf_token %}

                    <div
                        class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 dark:bg-blue-900/30 dark:text-blue-400">
                        <i class="fas fa-cloud-upload-alt text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2 dark:text-white">Upload your photo</h3>
                    <p class="text-sm text-gray-500 mb-6 max-w-xs mx-auto dark:text-gray-400">Supports JPG, PNG, WEBP,
                        BMP,
                        HEIC.
                        Max 30MB.</p>
                    <label
                        class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition cursor-pointer shadow-lg hover:shadow-blue-500/30 inline-flex items-center gap-2 w-full justify-center md:w-auto">
                        <i class="fas fa-image"></i> Select Photo
                        <input type="file" id="photo-input" class="hidden" accept="image/*">
                    </label>
                </div>

                <!-- Processing State -->
                <div id="progress-container" class="hidden text-center w-full max-w-md px-4">
                    <div class="relative w-24 h-24 mx-auto mb-8">
                        <div class="absolute inset-0 border-4 border-gray-200 rounded-full dark:border-gray-700"></div>
                        <div
                            class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin">
                        </div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="progress-percent" class="text-lg font-bold text-blue-600">0%</span>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2 dark:text-white">AI Processing</h3>
                    <p id="status-text" class="text-gray-500 text-sm mb-4 dark:text-gray-400">Analyzing image...</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden dark:bg-gray-700">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300 w-0">
                        </div>
                    </div>
                    <p id="est-time" class="text-xs text-gray-400 mt-2 font-mono">Estimated time: ~15 seconds</p>
                </div>

                <!-- Editor State -->
                <div id="result-container" class="hidden w-full h-full relative">
                    <!-- Feature 2: Quality Guardrail Alert -->
                    <div id="low-res-alert"
                        class="hidden absolute top-4 left-1/2 -translate-x-1/2 z-30 bg-orange-100 border-2 border-orange-400 text-orange-800 px-6 py-2.5 rounded-xl shadow-lg flex items-center gap-2 animate-bounce dark:bg-orange-900 dark:border-orange-500 dark:text-orange-100">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span class="text-xs font-bold">⚠️ Low Resolution Warning: Image too small!</span>
                    </div>

                    <!-- Feature 3: Compare Button -->
                    <button id="compare-btn" onmousedown="showOriginal(true)" onmouseup="showOriginal(false)"
                        ontouchstart="showOriginal(true)" ontouchend="showOriginal(false)"
                        class="absolute bottom-4 left-4 z-40 bg-white/90 backdrop-blur-md text-gray-700 px-4 py-2 rounded-xl font-bold shadow-lg flex items-center gap-2 hover:bg-white transition select-none">
                        <i class="fas fa-eye"></i> View Original
                    </button>

                    <!-- Main photo canvas (background) -->
                    <canvas id="editor-canvas"
                        class="w-full h-full object-contain absolute inset-0 bg-white shadow-2xl"></canvas>

                    <!-- Original Preview Layer (Hidden by default) -->
                    <div id="original-preview-container"
                        class="hidden absolute inset-0 z-20 bg-gray-100 dark:bg-gray-900 border-none">
                        <img id="original-preview-img" class="w-full h-full object-contain" src="">
                    </div>

                    <!-- Fabric Container (overlay for suits) -->
                    <div id="fabric-wrapper" class="absolute inset-0 z-10">
                        <canvas id="fabric-canvas"></canvas>
                    </div>

                    <!-- Grid Overlay Layer -->
                    <div id="official-grid" class="absolute inset-0 pointer-events-none hidden">
                        <div class="relative w-full h-full">
                            <!-- Eye Line (Approx 55%) -->
                            <div class="absolute top-[45%] left-0 w-full border-t border-dashed border-green-500/80">
                                <span
                                    class="absolute right-2 -top-4 text-[10px] font-bold text-green-500 whitespace-nowrap bg-white/50 px-1 rounded">EYE
                                    LEVEL</span>
                            </div>
                            <!-- Chin Line (Approx 80%) -->
                            <div class="absolute top-[80%] left-0 w-full border-t border-dashed border-red-500/80">
                                <span
                                    class="absolute right-2 -top-4 text-[10px] font-bold text-red-500 whitespace-nowrap bg-white/50 px-1 rounded">CHIN
                                    LEVEL</span>
                            </div>
                            <!-- Center Line -->
                            <div class="absolute left-1/2 top-0 h-full border-l border-dotted border-blue-400/50"></div>
                            <!-- Face Oval -->
                            <div
                                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[60%] h-[70%] border-2 border-blue-400/30 rounded-[50%]">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Guidelines -->
            {% if not country_rule.is_tool %}
            <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 dark:bg-blue-900/10 dark:border-blue-900/30">
                <h4 class="font-bold text-blue-900 mb-3 flex items-center gap-2 dark:text-blue-300">
                    <i class="fas fa-lightbulb text-yellow-500"></i> Smart Tips
                </h4>
                <ul class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-blue-800 dark:text-blue-200">
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check-circle text-blue-500 mt-0.5"></i>
                        <span>No shadows on face</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fas fa-check-circle text-blue-500 mt-0.5"></i>
                        <span>Eyes visible and open</span>
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>

        <!-- Right Column (Sidebar Controls) -->
        <div class="lg:col-span-5 xl:col-span-4 lg:order-2">
            <div
                class="bg-white rounded-2xl shadow-lg border border-gray-100 lg:sticky lg:top-8 dark:bg-gray-800 dark:border-gray-700">
                <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                    <h3 class="font-bold text-gray-900 flex items-center gap-2 dark:text-white">
                        <i class="fas fa-sliders-h text-blue-600"></i> Edit Options
                    </h3>
                </div>

                <div class="p-6 space-y-8">
                    <!-- Zoom Level (Top Prioritized for Mobile) -->
                    <div>
                        <div class="flex justify-between mb-3 items-end">
                            <label
                                class="text-xs font-bold text-gray-500 uppercase tracking-widest dark:text-gray-400">Zoom
                                Level</label>
                            <span id="zoom-val"
                                class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md dark:bg-blue-900/30 dark:text-blue-400">100%</span>
                        </div>
                        <input type="range" id="zoom-slider" min="50" max="200" value="100"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>

                    <!-- Background Color -->
                    <div>
                        <label
                            class="block text-sm font-bold text-gray-700 uppercase tracking-wider mb-4 dark:text-gray-300">Background</label>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="changeBg('#FFFFFF')"
                                class="w-12 h-12 md:w-10 md:h-10 rounded-full border-2 border-gray-200 shadow-md hover:scale-110 transition bg-white"
                                title="White"></button>
                            <button onclick="changeBg('#3560ad')"
                                class="w-12 h-12 md:w-10 md:h-10 rounded-full border-2 border-white shadow-md hover:scale-110 transition bg-[#3560ad]"
                                title="Blue"></button>
                            <button onclick="changeBg('#f44336')"
                                class="w-12 h-12 md:w-10 md:h-10 rounded-full border-2 border-white shadow-md hover:scale-110 transition bg-[#f44336]"
                                title="Red"></button>
                            <button onclick="changeBg('#eeeeee')"
                                class="w-12 h-12 md:w-10 md:h-10 rounded-full border-2 border-white shadow-md hover:scale-110 transition bg-[#eeeeee]"
                                title="Light Grey"></button>
                            <!-- Transparent Option -->
                            <button onclick="changeBg('transparent')"
                                class="w-12 h-12 md:w-10 md:h-10 rounded-full border-2 border-white shadow-md hover:scale-110 transition bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-gray-200"
                                title="Transparent (No Background)"></button>

                            <div
                                class="relative w-12 h-12 md:w-10 md:h-10 rounded-full border-2 border-white shadow-md overflow-hidden bg-[conic-gradient(from_0deg,#ff0000,#ffff00,#00ff00,#00ffff,#0000ff,#ff00ff,#ff0000)] items-center justify-center flex hover:scale-110 transition">
                                <input type="color" id="bg-picker" onchange="changeBg(this.value)"
                                    class="absolute scale-[3] cursor-pointer opacity-0">
                                <i class="fas fa-plus text-white drop-shadow-md pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Eraser Tool -->
                    <div>
                        <label
                            class="block text-sm font-bold text-gray-700 uppercase tracking-wider mb-4 dark:text-gray-300">Corrections</label>
                        <div class="flex gap-4 mb-4">
                            <button onclick="toggleEraser()" id="eraser-btn"
                                class="flex-1 py-3 px-4 rounded-xl border-2 border-gray-200 hover:border-red-400 hover:bg-red-50 transition flex items-center justify-center gap-2 group text-gray-600 font-bold dark:border-gray-700 dark:text-gray-300 dark:hover:bg-red-900/20">
                                <i class="fas fa-eraser text-red-500"></i> Magic Eraser
                            </button>
                        </div>

                        <!-- Eraser Controls -->
                        <div id="eraser-controls"
                            class="hidden space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-200 dark:bg-gray-800 dark:border-gray-700">
                            <div class="flex justify-between mb-1">
                                <label
                                    class="text-[10px] font-bold text-gray-500 uppercase tracking-widest dark:text-gray-400">Brush
                                    Size</label>
                                <span id="brush-size-val" class="text-[10px] font-bold text-blue-600">20px</span>
                            </div>
                            <input type="range" oninput="setBrushSize(this.value)" min="5" max="50" value="20"
                                class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">

                            <!-- Undo/Redo Actions -->
                            <div class="flex gap-2 pt-2">
                                <button onclick="undoEraser()" id="undo-btn" disabled
                                    class="flex-1 py-2 px-2 bg-white border border-gray-200 rounded-lg text-xs font-bold text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center gap-1 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300">
                                    <i class="fas fa-undo"></i> Undo
                                </button>
                                <button onclick="redoEraser()" id="redo-btn" disabled
                                    class="flex-1 py-2 px-2 bg-white border border-gray-200 rounded-lg text-xs font-bold text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center gap-1 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300">
                                    <i class="fas fa-redo"></i> Redo
                                </button>
                            </div>

                            <p class="text-[10px] text-gray-400 mt-2">Paint over background artifacts to remove them.
                            </p>
                        </div>
                    </div>

                    <!-- Name & Date Slate (New Task) -->
                    <div class="border-t border-gray-100 pt-6 dark:border-gray-700">
                        <label class="flex items-center gap-3 cursor-pointer group mb-4">
                            <div class="relative">
                                <input type="checkbox" id="enable-slate" onchange="toggleSlate()" class="sr-only peer">
                                <div
                                    class="w-10 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 transition-colors dark:bg-gray-700">
                                </div>
                                <div
                                    class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-4">
                                </div>
                            </div>
                            <span class="text-sm font-bold text-gray-700 dark:text-gray-300">Add Name & Date
                                Strip</span>
                        </label>

                        <div id="slate-inputs"
                            class="hidden space-y-4 bg-blue-50/50 p-4 rounded-xl border border-blue-100 dark:bg-blue-900/10 dark:border-blue-900/30">
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-blue-600 uppercase tracking-widest mb-1">Candidate
                                    Name</label>
                                <input type="text" id="slate-name" oninput="draw()"
                                    class="w-full bg-white border border-blue-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20 dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                                    placeholder="e.g. JOHN DOE">
                            </div>
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-blue-600 uppercase tracking-widest mb-1">Date
                                    of Photo</label>
                                <input type="text" id="slate-date" oninput="draw()"
                                    class="w-full bg-white border border-blue-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                            </div>
                            <p class="text-[9px] text-blue-400 italic">Required for UPSC, SSC, NEET, and many state
                                exams.</p>
                        </div>
                    </div>

                    <!-- Advanced Tools Panel -->
                    <div class="border-t border-gray-100 pt-8 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <label
                                class="block text-sm font-bold text-gray-700 uppercase tracking-wider dark:text-gray-300">Advanced
                                Tools</label>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase">Official Grid</span>
                                <button onclick="toggleGrid()" id="grid-toggle"
                                    class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none bg-gray-200 dark:bg-gray-700">
                                    <span id="grid-dot"
                                        class="pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Suit Up Wardrobe -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-[11px] font-black text-blue-600 uppercase tracking-widest">Suit Up
                                    Wardrobe</span>
                                <button onclick="clearSuit()"
                                    class="text-[10px] text-gray-400 hover:text-red-500 font-bold transition">Remove
                                    Suit</button>
                            </div>
                            <div
                                class="grid grid-cols-3 gap-2 p-3 bg-gray-50 rounded-xl border border-gray-200 dark:bg-gray-900/40 dark:border-gray-700">
                                <button onclick="applySuit('/media/assets/suits/suit1.png')"
                                    class="aspect-square bg-white rounded-lg border border-gray-200 hover:border-blue-400 transition p-1 dark:bg-gray-800 dark:border-gray-700 overflow-hidden">
                                    <img src="/media/assets/suits/suit1.png" class="w-full h-full object-contain"
                                        alt="Male Suit Blue">
                                </button>
                                <button onclick="applySuit('/media/assets/suits/suit2.png')"
                                    class="aspect-square bg-white rounded-lg border border-gray-200 hover:border-blue-400 transition p-1 dark:bg-gray-800 dark:border-gray-700 overflow-hidden">
                                    <img src="/media/assets/suits/suit2.png" class="w-full h-full object-contain"
                                        alt="Male Suit Black">
                                </button>
                                <button onclick="applySuit('/media/assets/suits/suit3.png')"
                                    class="aspect-square bg-white rounded-lg border border-gray-200 hover:border-blue-400 transition p-1 dark:bg-gray-800 dark:border-gray-700 overflow-hidden">
                                    <img src="/media/assets/suits/suit3.png" class="w-full h-full object-contain"
                                        alt="Male Shirt Red Tie">
                                </button>
                                <button onclick="applySuit('/media/assets/suits/suit4.png')"
                                    class="aspect-square bg-white rounded-lg border border-gray-200 hover:border-blue-400 transition p-1 dark:bg-gray-800 dark:border-gray-700 overflow-hidden">
                                    <img src="/media/assets/suits/suit4.png" class="w-full h-full object-contain"
                                        alt="Female Blazer Black">
                                </button>
                                <button onclick="applySuit('/media/assets/suits/suit5.png')"
                                    class="aspect-square bg-white rounded-lg border border-gray-200 hover:border-blue-400 transition p-1 dark:bg-gray-800 dark:border-gray-700 overflow-hidden">
                                    <img src="/media/assets/suits/suit5.png" class="w-full h-full object-contain"
                                        alt="Female Blazer Navy">
                                </button>
                                <button onclick="applySuit('/media/assets/suits/suit6.png')"
                                    class="aspect-square bg-white rounded-lg border border-gray-200 hover:border-blue-400 transition p-1 dark:bg-gray-800 dark:border-gray-700 overflow-hidden">
                                    <img src="/media/assets/suits/suit6.png" class="w-full h-full object-contain"
                                        alt="Female Blazer Grey">
                                </button>
                            </div>
                            <p class="text-[9px] text-gray-400 mt-2 text-center italic">Drag or pinch the suit to adjust
                                on
                                canvas.</p>
                        </div>

                        <!-- Print Sheet Option -->
                        <button onclick="generatePrintSheet()"
                            class="w-full py-3 px-4 bg-white border-2 border-blue-100 rounded-xl text-blue-600 font-bold text-sm hover:bg-blue-50 transition flex items-center justify-center gap-2 dark:bg-gray-800 dark:border-gray-700 dark:text-blue-400 dark:hover:bg-blue-900/20">
                            <i class="fas fa-print"></i> Download 4x6" Print Sheet (8 Photos)
                        </button>
                    </div>

                    <!-- Custom Dimensions (Only for Custom Size) -->
                    <!-- Editable Dimensions (Available for All) -->
                    <div
                        class="p-4 bg-blue-50 border border-blue-100 rounded-xl space-y-4 dark:bg-indigo-900/20 dark:border-indigo-800">
                        <label
                            class="block text-xs font-bold text-blue-700 uppercase tracking-widest dark:text-blue-300">Custom
                            Dimensions
                            (mm)</label>
                        <div class="grid grid-cols-[1fr_auto_1fr] gap-2 items-end">
                            <!-- Width Control -->
                            <div>
                                <span
                                    class="text-[10px] text-blue-400 font-bold uppercase block mb-1 dark:text-blue-500">Width</span>
                                <div
                                    class="flex items-center bg-white rounded-lg border border-blue-200 overflow-hidden shadow-sm dark:bg-gray-800 dark:border-gray-700">
                                    <button type="button" onclick="adjustDimension('custom-width', -1)"
                                        class="px-2 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 transition border-r border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600">
                                        <i class="fas fa-minus text-[10px]"></i>
                                    </button>
                                    <input type="number" id="custom-width" value="{{ country_rule.width_mm }}"
                                        oninput="handleDimensionChange('width')"
                                        class="w-full text-center text-sm font-bold text-blue-900 outline-none border-none bg-transparent [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none dark:text-white">
                                    <button type="button" onclick="adjustDimension('custom-width', 1)"
                                        class="px-2 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 transition border-l border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600">
                                        <i class="fas fa-plus text-[10px]"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Aspect Ratio Lock Button -->
                            <button type="button" id="aspect-ratio-lock" onclick="toggleAspectRatioLock()"
                                class="mb-0 w-10 h-10 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 transition flex items-center justify-center dark:bg-blue-900/30 dark:text-blue-400 dark:hover:bg-blue-900/50"
                                title="Lock aspect ratio">
                                <i id="lock-icon" class="fas fa-lock text-sm"></i>
                            </button>

                            <!-- Height Control -->
                            <div>
                                <span
                                    class="text-[10px] text-blue-400 font-bold uppercase block mb-1 dark:text-blue-500">Height</span>
                                <div
                                    class="flex items-center bg-white rounded-lg border border-blue-200 overflow-hidden shadow-sm dark:bg-gray-800 dark:border-gray-700">
                                    <button type="button" onclick="adjustDimension('custom-height', -1)"
                                        class="px-2 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 transition border-r border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600">
                                        <i class="fas fa-minus text-[10px]"></i>
                                    </button>
                                    <input type="number" id="custom-height" value="{{ country_rule.height_mm }}"
                                        oninput="handleDimensionChange('height')"
                                        class="w-full text-center text-sm font-bold text-blue-900 outline-none border-none bg-transparent [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none dark:text-white">
                                    <button type="button" onclick="adjustDimension('custom-height', 1)"
                                        class="px-2 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 transition border-l border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600">
                                        <i class="fas fa-plus text-[10px]"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="resetToOriginalSize()"
                                class="flex-1 bg-white border border-gray-200 text-gray-600 py-2 rounded-lg text-xs font-bold hover:bg-gray-50 transition flex items-center justify-center gap-1 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <button onclick="applyCustomDimensions()"
                                class="flex-[2] bg-blue-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition">
                                Apply New Size
                            </button>
                        </div>
                    </div>
                    <p class="text-[10px] text-blue-800 mt-3 leading-relaxed dark:text-blue-300">
                        <i class="fas fa-info-circle mr-1"></i>
                        <strong>Official Standard Pre-filled:</strong> These dimensions matches the latest government
                        requirements. Adjust only if you have specific instructions.
                    </p>
                </div>

                <!-- Fine-Tune Controls -->
                <div class="space-y-6">

                    <div
                        class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-4 dark:bg-indigo-900/20 dark:border-indigo-800">
                        <div class="flex justify-between items-center h-5">
                            <span class="text-xs font-bold text-blue-700 uppercase dark:text-blue-300">Current
                                Size:</span>
                            <span id="file-size-display"
                                class="text-sm font-black text-blue-800 dark:text-white">Calculating...</span>
                        </div>

                        <div class="pt-2 border-t border-blue-100/50 flex flex-col gap-3">
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-blue-600 uppercase tracking-wider mb-2 dark:text-blue-400">Save
                                    Filename As</label>
                                <div
                                    class="flex items-center bg-white rounded-lg border border-blue-200 overflow-hidden shadow-sm dark:bg-gray-800 dark:border-gray-700">
                                    <div
                                        class="px-3 py-2 bg-blue-50 text-blue-400 border-r border-blue-100 dark:bg-gray-700 dark:text-blue-500 dark:border-gray-600">
                                        <i class="fas fa-file-signature text-xs"></i>
                                    </div>
                                    <input type="text" id="save-filename" value="passport_photo"
                                        class="flex-grow px-3 py-2 text-sm font-bold text-blue-900 outline-none border-none bg-transparent min-w-0 dark:text-white"
                                        placeholder="Enter filename...">
                                    <span id="filename-ext"
                                        class="text-[10px] font-black text-blue-100 bg-blue-600 px-3 py-1 flex items-center justify-center min-w-[50px] self-stretch">.jpg</span>
                                </div>
                            </div>

                            <div>
                                <label
                                    class="block text-[10px] font-bold text-blue-600 uppercase tracking-wider mb-2 dark:text-blue-400">File
                                    Format</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button onclick="changeFormat('jpeg')" id="fmt-jpeg"
                                        class="fmt-btn active bg-blue-600 text-white py-1.5 rounded-lg text-xs font-bold transition">JPG</button>
                                    <button onclick="changeFormat('png')" id="fmt-png"
                                        class="fmt-btn bg-white text-blue-600 border border-blue-200 py-1.5 rounded-lg text-xs font-bold transition hover:bg-blue-50 dark:bg-gray-800 dark:text-blue-400 dark:border-gray-700 dark:hover:bg-gray-700">PNG</button>
                                    <button onclick="changeFormat('webp')" id="fmt-webp"
                                        class="fmt-btn bg-white text-blue-600 border border-blue-200 py-1.5 rounded-lg text-xs font-bold transition hover:bg-blue-50 dark:bg-gray-800 dark:text-blue-400 dark:border-gray-700 dark:hover:bg-gray-700">WEBP</button>
                                </div>
                            </div>
                        </div>

                        <div class="pt-2 border-t border-blue-100/50 dark:border-indigo-800/50">
                            <label
                                class="block text-[10px] font-bold text-blue-600 uppercase tracking-wider mb-2 dark:text-blue-400">Target
                                Download Size</label>
                            <div
                                class="flex items-center bg-white rounded-lg border border-blue-200 overflow-hidden shadow-sm dark:bg-gray-800 dark:border-gray-700">
                                <button type="button" onclick="adjustTarget(-50)"
                                    class="px-3 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 active:bg-blue-200 transition border-r border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600">
                                    <i class="fas fa-minus text-xs"></i>
                                </button>
                                <div class="flex-grow flex items-center px-4">
                                    <input type="number" id="target-kb" value="{{ target_kb|default:350 }}" min="50"
                                        max="2500"
                                        class="w-16 text-center text-sm font-black text-blue-900 outline-none border-none bg-transparent [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none dark:text-white">
                                    <span class="text-xs font-bold text-blue-400 ml-1 dark:text-blue-500">KB</span>
                                </div>
                                <button type="button" onclick="adjustTarget(50)"
                                    class="px-3 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 active:bg-blue-200 transition border-l border-blue-100 dark:bg-gray-700 dark:text-blue-300 dark:border-gray-600">
                                    <i class="fas fa-plus text-xs"></i>
                                </button>
                            </div>
                            <p class="text-[9px] text-blue-400 mt-2 italic leading-tight dark:text-blue-500">
                                Upscales automatically to
                                reach larger targets.</p>
                            <div
                                class="mt-3 p-2 bg-blue-100/50 rounded-lg border border-blue-200 dark:bg-blue-900/40 dark:border-blue-800">
                                <p class="text-[9px] text-blue-700 leading-normal dark:text-blue-300">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    If the image download size is increased our AI will process the image and
                                    autoscale your given image for better quality.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-8 border-t border-gray-100 flex flex-col gap-4">
                    <button onclick="downloadFinal(event)"
                        class="w-full bg-gradient-to-r from-emerald-500 to-green-600 text-white px-8 py-4 rounded-2xl font-bold text-lg hover:shadow-lg hover:shadow-green-200 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-3">
                        <i class="fas fa-arrow-down"></i> Download
                    </button>
                    <button onclick="location.reload()"
                        class="w-full text-gray-500 font-bold hover:text-blue-600 hover:bg-gray-50 py-4 rounded-2xl transition flex items-center justify-center gap-2">
                        <i class="fas fa-redo"></i> Start Over
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Custom Size Background Option Modal -->
<div id="bg-option-modal"
    class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
    <div
        class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform transition-all scale-100 dark:bg-gray-800 dark:border dark:border-gray-700">
        <div class="text-center mb-6">
            <div
                class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 dark:bg-blue-900/30">
                <i class="fas fa-magic text-2xl text-blue-600 dark:text-blue-400"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2 dark:text-white">Process Image?</h3>
            <p class="text-gray-500 text-sm dark:text-gray-400">
                Do you want our AI to remove the background, or just convert the format/size?
            </p>
        </div>

        <div class="space-y-3" id="modal-buttons">
            <button id="btn-remove-bg"
                class="w-full bg-blue-600 text-white rounded-xl py-4 font-bold hover:bg-blue-700 hover:shadow-lg hover:-translate-y-0.5 transition-all flex items-center justify-center gap-3">
                <i class="fas fa-user-edit"></i> <span id="btn-remove-bg-text">Remove Background (Default)</span>
            </button>
            <div class="relative flex py-1 items-center">
                <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
                <span class="flex-shrink-0 mx-4 text-gray-400 text-xs uppercase font-bold">Or</span>
                <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
            </div>
            <button id="btn-keep-original"
                class="w-full bg-white text-gray-700 border border-gray-200 rounded-xl py-3 font-bold hover:bg-gray-50 hover:text-blue-600 transition-all flex items-center justify-center gap-3 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600">
                <i class="fas fa-image"></i> <span id="btn-keep-original-text">Keep Original Background</span>
            </button>
        </div>
        <button id="btn-cancel-upload"
            class="mt-6 text-gray-400 text-xs font-bold hover:text-gray-600 block mx-auto transition dark:hover:text-gray-300">
            Cancel
        </button>
    </div>
</div>

<!-- Content Area -->
<div
    class="bg-white rounded-2xl shadow-sm p-8 border border-gray-100 prose max-w-none dark:bg-gray-800 dark:border-gray-700 dark:prose-invert {% if country_rule.country == 'Custom Size' %}hidden{% endif %}">
    <h2 class="text-2xl font-bold mb-4 dark:text-white">Requirements for {{country_rule.country}} Passport Photo
    </h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="p-4 bg-gray-50 rounded-lg text-center dark:bg-gray-700/50">
            <span
                class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1 dark:text-gray-400">Size</span>
            <span
                class="text-lg font-bold text-gray-900 dark:text-white">{{country_rule.width_mm}}x{{country_rule.height_mm}}mm</span>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg text-center dark:bg-gray-700/50">
            <span
                class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1 dark:text-gray-400">Background</span>
            <span class="text-lg font-bold text-gray-900 dark:text-white">{{country_rule.bg_color|capfirst}}</span>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg text-center dark:bg-gray-700/50">
            <span
                class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1 dark:text-gray-400">Quality</span>
            <span class="text-lg font-bold text-gray-900 dark:text-white">300 DPI</span>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg text-center dark:bg-gray-700/50">
            <span
                class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-1 dark:text-gray-400">Format</span>
            <span class="text-lg font-bold text-gray-900 dark:text-white">JPG, PNG, WEBP</span>
        </div>
    </div>

    <!-- Ad Slot 2 -->
    <div class="ad-placeholder my-8">
        <p class="text-xs uppercase tracking-widest text-gray-400">Advertisement</p>
    </div>

    <div class="mt-8">
        {{ country_rule.content_body|safe }}
    </div>
</div>

<!-- SEO Guide Section -->
{% if country_rule.guide_steps %}
<section id="guide"
    class="mt-16 bg-white rounded-3xl shadow-sm p-8 md:p-12 border border-gray-100 dark:bg-gray-800 dark:border-gray-700">
    <h2 class="text-3xl font-bold text-gray-900 mb-8 dark:text-white text-center">How to create a {{ country_rule.country|default:'Passport' }} photo</h2>
    <div class="prose prose-blue max-w-none dark:prose-invert">
        {{ country_rule.guide_steps|safe }}
    </div>
</section>
{% endif %}

<!-- Specifications Section -->
<section id="specifications" class="mt-16">
    <h2 class="text-3xl font-bold text-gray-900 mb-8 dark:text-white text-center">Ultimate Guide to {{ country_rule.country|default:'Passport' }} Photos</h2>

    <!-- Dynamic AI-Generated SEO Content -->
    <div
        class="bg-gray-50 rounded-3xl p-10 md:p-12 mb-12 border border-gray-100 dark:bg-gray-900/50 dark:border-gray-700">
        {{ generated_seo_content|safe }}
    </div>

    <div class="overflow-hidden rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm">
        <table class="w-full text-left bg-white dark:bg-gray-800">
            <thead class="bg-gray-50 dark:bg-gray-700/50">
                <tr>
                    <th class="px-6 py-4 text-sm font-bold text-gray-500 uppercase tracking-wider dark:text-gray-400">
                        Attribute</th>
                    <th class="px-6 py-4 text-sm font-bold text-gray-500 uppercase tracking-wider dark:text-gray-400">
                        Official Requirement</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                <tr>
                    <td class="px-6 py-4 font-bold text-gray-700 dark:text-gray-300">Photo Size</td>
                    <td class="px-6 py-4 text-gray-600 dark:text-gray-400">{{ country_rule.width_mm }}mm x {{ country_rule.height_mm }}mm</td>
                </tr>
                <tr>
                    <td class="px-6 py-4 font-bold text-gray-700 dark:text-gray-300">Background Color</td>
                    <td class="px-6 py-4 text-gray-600 dark:text-gray-400">{{ country_rule.bg_color|capfirst }}</td>
                </tr>
                <tr>
                    <td class="px-6 py-4 font-bold text-gray-700 dark:text-gray-300">File Format</td>
                    <td class="px-6 py-4 text-gray-600 dark:text-gray-400">JPEG, PNG, WEBP, BMP</td>
                </tr>
                <tr>
                    <td class="px-6 py-4 font-bold text-gray-700 dark:text-gray-300">Resolution</td>
                    <td class="px-6 py-4 text-gray-600 dark:text-gray-400">300 DPI (High Quality)</td>
                </tr>
            </tbody>
        </table>
    </div>
</section>

<!-- FAQ Section -->
{% if faqs %}
<section id="faq" class="mt-16 mb-20">
    <h2 class="text-3xl font-bold text-gray-900 mb-10 dark:text-white text-center">Frequently Asked Questions</h2>
    <div class="max-w-4xl mx-auto space-y-4">
        {% for faq in faqs %}
        <div
            class="bg-white rounded-2xl border border-gray-100 p-6 shadow-sm hover:shadow-md transition-shadow dark:bg-gray-800 dark:border-gray-700">
            <h3 class="text-lg font-bold text-gray-900 mb-3 dark:text-white">{{ faq.q }}</h3>
            <p class="text-gray-600 dark:text-gray-400">{{ faq.a }}</p>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}
</div>

<script>


    console.log("Script loaded successfully!");
    // alert("Debug: Script Loaded"); // Prove the script runs
    let canvas, ctx, img;
    let scale = 1.0;
    let posX = 0, posY = 0;
    let isDragging = false;
    let lastMouseX, lastMouseY;
    let bgColor = '#FFFFFF';
    const countryName = "{{ country_rule.country|default:''|escapejs }}";
    const isTool = {% if country_rule.is_tool %}true{% else %} false{% endif %};

    let pendingFile = null;
    let originalImgUrl = null;

    // Aspect Ratio Lock
    let aspectRatioLocked = true; // Default to locked
    let aspectRatio = 1.0;

    function toggleAspectRatioLock() {
        aspectRatioLocked = !aspectRatioLocked;
        const lockBtn = document.getElementById('aspect-ratio-lock');
        const lockIcon = document.getElementById('lock-icon');

        if (aspectRatioLocked) {
            lockIcon.className = 'fas fa-lock text-sm';
            lockBtn.className = 'mb-0 w-10 h-10 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 transition flex items-center justify-center dark:bg-blue-900/30 dark:text-blue-400 dark:hover:bg-blue-900/50';
            lockBtn.title = 'Unlock aspect ratio';

            // Calculate current aspect ratio
            const wInput = document.getElementById('custom-width');
            const hInput = document.getElementById('custom-height');
            if (wInput && hInput) {
                const w = parseFloat(wInput.value);
                const h = parseFloat(hInput.value);
                if (w > 0 && h > 0) {
                    aspectRatio = w / h;
                }
            }
        } else {
            lockIcon.className = 'fas fa-unlock text-sm';
            lockBtn.className = 'mb-0 w-10 h-10 rounded-lg bg-gray-100 text-gray-500 hover:bg-gray-200 transition flex items-center justify-center dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600';
            lockBtn.title = 'Lock aspect ratio';
        }
    }

    function handleDimensionChange(changedDimension) {
        if (aspectRatioLocked) {
            const wInput = document.getElementById('custom-width');
            const hInput = document.getElementById('custom-height');

            if (changedDimension === 'width') {
                const newWidth = parseFloat(wInput.value);
                if (newWidth > 0 && aspectRatio > 0) {
                    hInput.value = (newWidth / aspectRatio).toFixed(1);
                }
            } else if (changedDimension === 'height') {
                const newHeight = parseFloat(hInput.value);
                if (newHeight > 0 && aspectRatio > 0) {
                    wInput.value = (newHeight * aspectRatio).toFixed(1);
                }
            }
        }

        applyCustomDimensions();
    }

    function showOriginal(show) {
        const preview = document.getElementById('original-preview-container');
        const imgEl = document.getElementById('original-preview-img');
        if (show && originalImgUrl) {
            imgEl.src = originalImgUrl;
            preview.classList.remove('hidden');
        } else {
            preview.classList.add('hidden');
        }
    }



    document.getElementById('photo-input').addEventListener('change', function (e) {
        try {
            console.log('Photo input changed!', e.target.files);
            if (!e.target.files[0]) return;
            const file = e.target.files[0];

            // Store original local URL for comparison
            if (originalImgUrl) URL.revokeObjectURL(originalImgUrl);
            originalImgUrl = URL.createObjectURL(file);

            // Show modal for Custom Size or Tool pages
            console.log('Checking modal condition - countryName:', countryName, 'isTool:', isTool);
            if (countryName === 'Custom Size' || isTool) {
                console.log('Showing modal!');
                pendingFile = file;
                document.getElementById('bg-option-modal').classList.remove('hidden');
            } else {
                // Regular photo pages: auto-remove background
                startUpload(file, false);
            }
        } catch (err) {
            console.error(err);
        }
    });

    // Modal Handlers
    document.getElementById('btn-remove-bg').addEventListener('click', () => {
        document.getElementById('bg-option-modal').classList.add('hidden');
        if (pendingFile) {
            startUpload(pendingFile, false);
        } else {
            alert('Error: No pending file (btn-remove-bg).');
        }
    });

    document.getElementById('btn-keep-original').addEventListener('click', () => {
        console.log('Keep Original button clicked! pendingFile:', pendingFile);
        document.getElementById('bg-option-modal').classList.add('hidden');
        if (pendingFile) {
            console.log('Starting upload without background removal...');
            startUpload(pendingFile, true);
        } else {
            console.error('No pending file!');
        }
    });

    document.getElementById('btn-cancel-upload').addEventListener('click', () => {
        document.getElementById('bg-option-modal').classList.add('hidden');
        document.getElementById('photo-input').value = ''; // Reset input
        pendingFile = null;
    });

    async function startUpload(file, skipBg) {
        try {

            console.log('startUpload called with file:', file, 'skipBg:', skipBg);

            if (!file) {
                console.error('No file provided to startUpload!');
                alert('No file selected. Please try again.');
                return;
            }

            const formData = new FormData();
            formData.append('photo', file);
            console.log('Appended photo to FormData:', file.name, file.size, 'bytes');

            const csrfToken = '{{ csrf_token }}';
            formData.append('csrfmiddlewaretoken', csrfToken);
            console.log('Appended CSRF token:', csrfToken.substring(0, 10) + '...');
            if (skipBg) {
                formData.append('skip_bg', 'true');
            }


            const isSignature = countryName === 'Signature Resizer';
            const isCustomSize = countryName === 'Custom Size';

            if ((isTool && !isSignature) || isCustomSize) {
                formData.append('use_original_dimensions', 'true');
            }

            document.getElementById('upload-container').classList.add('hidden');
            document.getElementById('progress-container').classList.remove('hidden');

            let progress = 0;
            let timeLeft = 15; // Initial estimated time
            const interval = setInterval(() => {
                if (progress < 90) {
                    progress += (progress < 60) ? 2 : 0.5; // Faster progress at the start
                    updateProgress(Math.floor(progress), "AI is processing your photo...");
                }
                const estElement = document.getElementById('est-time');
                if (estElement) {
                    if (timeLeft > 2) {
                        timeLeft -= 0.5;
                        estElement.innerText = `Estimated time: ~${Math.ceil(timeLeft)} seconds`;
                    } else if (timeLeft <= 2 && estElement.innerText !== "Almost done...") {
                        estElement.innerText = "Almost done...";
                    }
                }
            }, 500);

            try {
                console.log('Sending POST request to /api/upload/{{ country_rule.slug }}/');
                console.log('FormData contents:', Array.from(formData.entries()).map(([k, v]) => k + ': ' + (v instanceof File ? v.name : v)));
                const response = await fetch('/api/upload/{{ country_rule.slug }}/', { method: 'POST', body: formData });
                console.log("Upload response status:", response.status);
                const data = await response.json();
                if (data.status === 'processing' || data.status === 'success') {
                    console.log("Upload success, checking status for ID:", data.photo_id);
                    checkStatus(data.photo_id, interval);
                } else {
                    alert("Error: " + (data.error || data.message || "Upload failed"));
                    location.reload();
                }
            } catch (err) {
                console.error("Upload Error: " + err.message);
            }
        } catch (criticalErr) { // Outer catch
            console.error("Critical Code Error: " + criticalErr.message);
        }
    }

    function updateProgress(percent, text) {
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-percent').innerText = percent + '%';
        if (text) document.getElementById('status-text').innerText = text;
    }

    let pollAttempts = 0;
    const MAX_POLL_ATTEMPTS = 120; // 60 seconds (approx)

    async function checkStatus(photoId, interval) {
        pollAttempts++;
        if (pollAttempts > MAX_POLL_ATTEMPTS) {
            clearInterval(interval);
            alert("Processing timed out. Please try again.");
            location.reload();
            return;
        }

        try {
            const response = await fetch(`/api/status/${photoId}/`);
            if (!response.ok) throw new Error("Network response was not ok");
            const data = await response.json();

            if (data.status === 'completed') {
                console.log("Processing completed!");
                clearInterval(interval);
                updateProgress(100, "Ready!");
                const estElement = document.getElementById('est-time');
                if (estElement) estElement.innerText = "Done!";

                // Slight delay to ensure UI updates before heavy rendering
                setTimeout(() => initEditor(data.processed_url), 100);
            } else if (data.status === 'failed') {
                clearInterval(interval);
                alert("Processing failed: " + (data.error || "Unknown error"));
                location.reload();
            } else {
                // Determine next poll interval based on attempts
                const delay = pollAttempts < 10 ? 1000 : 2000;
                setTimeout(() => checkStatus(photoId, interval), delay);
            }
        } catch (err) {
            console.error(err);
            // Retry on network error unless max attempts reached
            setTimeout(() => checkStatus(photoId, interval), 2000);
        }
    }

    // --- Advanced Features ---
    let fabricCanvas;
    let mainPhotoLayer;
    let currentSuitObject = null;
    let showGrid = false;

    function toggleGrid() {
        showGrid = !showGrid;
        const grid = document.getElementById('official-grid');
        const dot = document.getElementById('grid-dot');
        const toggle = document.getElementById('grid-toggle');

        if (showGrid) {
            grid.classList.remove('hidden');
            dot.classList.add('translate-x-4');
            toggle.classList.add('bg-blue-600');
        } else {
            grid.classList.add('hidden');
            dot.classList.remove('translate-x-4');
            toggle.classList.remove('bg-blue-600');
        }
    }

    function applySuit(url) {
        if (!fabricCanvas) return;

        // Remove existing suit if any
        if (currentSuitObject) {
            fabricCanvas.remove(currentSuitObject);
        }

        fabric.Image.fromURL(url, function (img) {
            // Programmatic Chroma-key (Remove green background)
            img.filters.push(new fabric.Image.filters.RemoveColor({
                color: '#00ff00', // Typical bright green
                distance: 0.2    // Tolerance
            }));
            img.applyFilters();

            // Scaled better for Shoulder-Up (Bust) view
            img.scaleToWidth(fabricCanvas.width * 0.95);
            img.set({
                left: fabricCanvas.width / 2,
                top: fabricCanvas.height * 0.85, // Lowered for shoulder view
                originX: 'center',
                originY: 'center',
                cornerColor: '#3b82f6',
                cornerSize: 12,
                transparentCorners: false,
                borderColor: '#3b82f6',
                borderScaleFactor: 2
            });

            fabricCanvas.add(img);
            fabricCanvas.setActiveObject(img);
            currentSuitObject = img;
            fabricCanvas.renderAll();
        }, { crossOrigin: 'anonymous' });
    }

    function clearSuit() {
        if (currentSuitObject) {
            fabricCanvas.remove(currentSuitObject);
            currentSuitObject = null;
            fabricCanvas.renderAll();
        }
    }

    async function generatePrintSheet() {
        if (!canvas) return;

        // Finalize canvas content (merge fabric layers)
        const finalImgData = await getFinalImageData(1.0, 1.0);

        const printCanvas = document.createElement('canvas');
        // 4x6 inch at 300 DPI = 1200x1800 px
        printCanvas.width = 1800;
        printCanvas.height = 1200;
        const pCtx = printCanvas.getContext('2d');

        pCtx.fillStyle = 'white';
        pCtx.fillRect(0, 0, printCanvas.width, printCanvas.height);

        const photo = new Image();
        photo.onload = () => {
            // Target size for each photo on sheet
            // A 35x45mm photo at 300 DPI is approx 413x531px
            // On a 1800x1200 sheet, we can fit 2 rows of 4 photos (or similar)

            const wMm = parseFloat("{{ country_rule.width_mm }}");
            const hMm = parseFloat("{{ country_rule.height_mm }}");
            const wPx = (wMm / 25.4) * 300;
            const hPx = (hMm / 25.4) * 300;

            const margin = 20;
            const startX = (printCanvas.width - (wPx * 4 + margin * 3)) / 2;
            const startY = (printCanvas.height - (hPx * 2 + margin * 1)) / 2;

            for (let i = 0; i < 2; i++) { // 2 rows
                for (let j = 0; j < 4; j++) { // 4 columns
                    pCtx.drawImage(photo,
                        startX + j * (wPx + margin),
                        startY + i * (hPx + margin),
                        wPx, hPx
                    );
                }
            }

            const link = document.createElement('a');
            link.download = `print_sheet_4x6_${document.getElementById('save-filename').value}.jpg`;
            link.href = printCanvas.toDataURL('image/jpeg', 0.95);
            link.click();
        };
        photo.src = finalImgData;
    }

    // Global variables to store default/original dimensions
    let defaultWidthMm = null;
    let defaultHeightMm = null;

    function initEditor(imgData) {
        console.log("Initializing Editor...");
        document.getElementById('progress-container').classList.add('hidden');
        document.getElementById('result-container').classList.remove('hidden');

        originalImgUrl = imgData; // Feature 3: Store for comparison

        canvas = document.getElementById('editor-canvas');

        ctx = canvas.getContext('2d');

        const widthMm = parseFloat("{{ country_rule.width_mm }}");
        const heightMm = parseFloat("{{ country_rule.height_mm }}");


        canvas.width = (widthMm / 25.4) * 300;
        canvas.height = (heightMm / 25.4) * 300;

        // Init Fabric
        fabricCanvas = new fabric.Canvas('fabric-canvas', {
            width: document.getElementById('fabric-wrapper').clientWidth,
            height: document.getElementById('fabric-wrapper').clientHeight,
            backgroundColor: 'transparent',
            selection: false
        });

        img = new Image();
        img.onerror = function (e) {
            alert("Error loading processed image.");
        };

        img.onload = () => {
            // Feature 2: Quality Guardrail - Resolution Check
            const lowResBanner = document.getElementById('low-res-alert');
            if (img.width < 400 || img.height < 400) {
                lowResBanner.classList.remove('hidden');
            } else {
                lowResBanner.classList.add('hidden');
            }

            posX = 0;
            posY = 0;

            // const countryName moved to global scope

            // Set defaults for Reset button
            const ruleWidthPx = "{{ country_rule.width_px|default_if_none:'null' }}";
            const ruleHeightPx = "{{ country_rule.height_px|default_if_none:'null' }}";
            const ruleRequiresOverlay = "{{ country_rule.requires_name_overlay|yesno:'true,false' }}";

            defaultWidthMm = parseFloat("{{ country_rule.width_mm }}");
            defaultHeightMm = parseFloat("{{ country_rule.height_mm }}");

            // If pixel override exists, update defaults
            if (ruleWidthPx !== 'null' && ruleHeightPx !== 'null') {
                // Convert pixels to mm for standard inputs logic (assuming 300 DPI)
                // 300px / 300dpi * 25.4 = 25.4mm
                const pxW = parseInt(ruleWidthPx);
                const pxH = parseInt(ruleHeightPx);
                defaultWidthMm = (pxW / 300) * 25.4;
                defaultHeightMm = (pxH / 300) * 25.4;

                // Set canvas directly to pixels if precise
                canvas.width = pxW;
                canvas.height = pxH;

                // Update inputs
                const wInput = document.getElementById('custom-width');
                const hInput = document.getElementById('custom-h eight');


                if (wInput && hInput) {
                    wInput.value = defaultWidthMm.toFixed(1);
                    hInput.value = defaultHeightMm.toFixed(1);
                }
            }

            // For tool pages (except signature resizer), use original image dimensions
            // const isTool used from global scope

            const isSignature = countryName === 'Signature Resizer';

            if ((countryName === 'Custom Size') || (isTool && !isSignature)) {
                const imgWidthMm = (img.width * 25.4) / 300;
                const imgHeightMm = (img.height * 25.4) / 300;

                defaultWidthMm = imgWidthMm;
                defaultHeightMm = imgHeightMm;

                const wInput = document.getElementById('custom-width');
                const hInput = document.getElementById('custom-height');
                if (wInput && hInput) {
                    wInput.value = imgWidthMm.toFixed(1);
                    hInput.value = imgHeightMm.toFixed(1);
                }
                canvas.width = img.width;
                canvas.height = img.height;
            }

            maskCanvas.width = img.width;
            maskCanvas.height = img.height;
            maskCtx = maskCanvas.getContext('2d');

            // Sync Fabric size with wrapper
            fabricCanvas.setWidth(document.getElementById('fabric-wrapper').clientWidth);
            fabricCanvas.setHeight(document.getElementById('fabric-wrapper').clientHeight);

            draw();
        };
        img.src = imgData;

        const zoomSlider = document.getElementById('zoom-slider');
        const floatingZoomVal = document.getElementById('floating-zoom-val');

        function updateZoomUI(val) {
            scale = val / 100;
            document.getElementById('zoom-val').innerText = val + '%';
            if (floatingZoomVal) floatingZoomVal.innerText = val + '%';
            if (zoomSlider) zoomSlider.value = val;
            draw();
        }

        zoomSlider.oninput = (e) => {
            updateZoomUI(e.target.value);
        };

        window.stepZoom = function (delta) {
            let currentVal = parseInt(zoomSlider.value);
            let newVal = currentVal + delta;
            if (newVal < 10) newVal = 10;
            if (newVal > 400) newVal = 400;
            updateZoomUI(newVal);
        };

        const wrapper = document.getElementById('fabric-wrapper');

        // Helper for coordinated touch/mouse events
        function getPointer(e) {
            if (e.touches && e.touches.length > 0) {
                return e.touches[0];
            }
            return e;
        }

        // Combined Event Handling using Fabric.js
        fabricCanvas.on('mouse:down', function (options) {
            if (!options.target) {
                isDragging = true;
                const pointer = getPointer(options.e);
                if (isErasing) {
                    saveEraserState();
                    lastImgX = null;
                    lastImgY = null;
                    drawMask(pointer);
                } else {
                    lastMouseX = pointer.clientX;
                    lastMouseY = pointer.clientY;
                }
            }
        });

        fabricCanvas.on('mouse:move', function (options) {
            if (!isDragging) return;
            const pointer = getPointer(options.e);

            if (isErasing) {
                drawMask(pointer);
            } else {
                const dx = pointer.clientX - lastMouseX;
                const dy = pointer.clientY - lastMouseY;

                // Use wrapper dimensions for scaling mouse delta
                const clientW = wrapper.clientWidth;
                const clientH = wrapper.clientHeight;

                posX += dx * (canvas.width / clientW);
                posY += dy * (canvas.height / clientH);

                lastMouseX = pointer.clientX;
                lastMouseY = pointer.clientY;
                draw();
            }
        });

        fabricCanvas.on('mouse:up', function () {
            isDragging = false;
        });

        // Re-draw on window resize
        window.onresize = () => {
            fabricCanvas.setWidth(wrapper.clientWidth);
            fabricCanvas.setHeight(wrapper.clientHeight);
            draw();
        };
    }

    function resetToOriginalSize() {
        if (defaultWidthMm !== null && defaultHeightMm !== null) {
            const wInput = document.getElementById('custom-width');
            const hInput = document.getElementById('custom-height');

            if (wInput && hInput) {
                wInput.value = defaultWidthMm.toFixed(1);
                hInput.value = defaultHeightMm.toFixed(1);
                applyCustomDimensions();
            }
        }
    }

    function applyCustomDimensions() {
        const wInput = document.getElementById('custom-width');
        const hInput = document.getElementById('custom-height');
        if (!wInput || !hInput) return;

        const wMm = parseFloat(wInput.value);
        const hMm = parseFloat(hInput.value);

        if (wMm > 0 && hMm > 0) {
            canvas.width = (wMm / 25.4) * 300;
            canvas.height = (hMm / 25.4) * 300;
            draw();
        }
    }

    function adjustDimension(id, delta) {
        const input = document.getElementById(id);
        if (!input) return;
        let val = parseInt(input.value) || 0;
        val += delta;
        if (val < 1) val = 1; // Minimum constraint
        input.value = val;

        // Trigger dimension change handler to respect aspect ratio lock
        const changedDim = id === 'custom-width' ? 'width' : 'height';
        handleDimensionChange(changedDim);
    }

    let currentFormat = 'jpeg';
    function changeFormat(fmt) {
        currentFormat = fmt;

        const baseClasses = "fmt-btn py-1.5 rounded-lg text-xs font-bold transition";
        const inactiveClasses = "bg-white text-blue-600 border border-blue-200 hover:bg-blue-50 dark:bg-gray-800 dark:text-blue-400 dark:border-gray-700 dark:hover:bg-gray-700";
        const activeClasses = "active bg-blue-600 text-white shadow-md";

        const buttons = document.querySelectorAll('.fmt-btn');
        buttons.forEach(b => {
            // Reset all to inactive
            b.className = `${baseClasses} ${inactiveClasses}`;
        });

        const activeBtn = document.getElementById('fmt-' + fmt);
        if (activeBtn) {
            // Set active
            activeBtn.className = `${baseClasses} ${activeClasses}`;
        }

        const extDisplay = document.getElementById('filename-ext');
        if (extDisplay) extDisplay.innerText = '.' + (fmt === 'jpeg' ? 'jpg' : fmt);
        updateFileSize();
    }

    function changeBg(color) {
        bgColor = color;
        if (color === 'transparent' && currentFormat === 'jpeg') {
            changeFormat('png');
            alert("Switched to PNG format to preserve transparency.");
        }
        draw();
    }

    function adjustTarget(delta) {
        const input = document.getElementById('target-kb');
        let val = parseInt(input.value) || 300;
        val += delta;
        if (val < 50) val = 50;
        if (val > 3000) val = 3000;
        input.value = val;
    }

    // --- Eraser Logic ---
    let isErasing = false;
    let maskCanvas = document.createElement('canvas'); // Offscreen canvas for mask
    let maskCtx = maskCanvas.getContext('2d');
    let brushSize = 20;

    // Undo/Redo Stacks
    let eraserHistory = [];
    let eraserRedoStack = [];
    const MAX_HISTORY = 20;

    // Track previous position for smooth line drawing
    let lastImgX = null;
    let lastImgY = null;

    function saveEraserState() {
        // Save current mask state to history
        eraserHistory.push(maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height));
        if (eraserHistory.length > MAX_HISTORY) eraserHistory.shift();

        // Clear redo stack on new action
        eraserRedoStack = [];
        updateEraserButtons();
    }

    function undoEraser() {
        if (eraserHistory.length === 0) return;

        // Save current state to redo stack
        eraserRedoStack.push(maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height));

        // Restore previous state
        const prevState = eraserHistory.pop();
        maskCtx.putImageData(prevState, 0, 0);

        draw();
        updateEraserButtons();
    }

    function redoEraser() {
        if (eraserRedoStack.length === 0) return;

        // Save current state to history
        eraserHistory.push(maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height));

        // Restore next state
        const nextState = eraserRedoStack.pop();
        maskCtx.putImageData(nextState, 0, 0);

        draw();
        updateEraserButtons();
    }

    function updateEraserButtons() {
        document.getElementById('undo-btn').disabled = eraserHistory.length === 0;
        document.getElementById('redo-btn').disabled = eraserRedoStack.length === 0;
    }

    function toggleEraser() {
        isErasing = !isErasing;
        const btn = document.getElementById('eraser-btn');
        const controls = document.getElementById('eraser-controls');

        if (isErasing) {
            btn.classList.add('bg-red-50', 'border-red-400', 'text-red-600', 'ring-2', 'ring-red-200');
            btn.innerHTML = '<i class="fas fa-check text-red-500"></i> Done Erasing';
            controls.classList.remove('hidden');
            document.getElementById('canvas-wrapper').style.cursor = 'crosshair';
            updateEraserButtons();
        } else {
            btn.classList.remove('bg-red-50', 'border-red-400', 'text-red-600', 'ring-2', 'ring-red-200');
            btn.innerHTML = '<i class="fas fa-eraser text-red-500"></i> Magic Eraser';
            controls.classList.add('hidden');
            document.getElementById('canvas-wrapper').style.cursor = 'grab';
        }
    }

    function setBrushSize(val) {
        brushSize = parseInt(val);
        document.getElementById('brush-size-val').innerText = val + 'px';
    }

    // Helper to map mouse coordinates to image local coordinates
    function drawMask(e) {
        if (!img) return;

        const wrapper = document.getElementById('canvas-wrapper');
        const rect = wrapper.getBoundingClientRect();

        // Mouse pos relative to canvas element (visual)
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // Convert to actual canvas pixel coordinates
        const canvasX = mouseX * (canvas.width / wrapper.clientWidth);
        const canvasY = mouseY * (canvas.height / wrapper.clientHeight);

        // Convert to Image Local Coordinates
        // Image is drawn at posX, posY with size (img.width*scale, img.height*scale)
        // We want to draw on the maskCanvas which matches the ORIGINAL image size 1:1

        // 1. Offset by image position
        const relX = canvasX - posX;
        const relY = canvasY - posY;

        // 2. Scale down to original image size
        const imgX = relX / scale;
        const imgY = relY / scale;

        // Draw on mask
        maskCtx.globalCompositeOperation = 'source-over';
        maskCtx.lineCap = 'round';
        maskCtx.lineJoin = 'round';
        maskCtx.lineWidth = brushSize / scale; // Adjust brush size relative to image scale
        maskCtx.strokeStyle = 'black'; // Color doesn't matter, we use it for masking
        maskCtx.fillStyle = 'black';

        maskCtx.beginPath();

        if (lastImgX !== null && lastImgY !== null) {
            // Draw continuous line from last position
            maskCtx.moveTo(lastImgX, lastImgY);
            maskCtx.lineTo(imgX, imgY);
            maskCtx.stroke();
        } else {
            // Single point (click or start of stroke)
            maskCtx.arc(imgX, imgY, (brushSize / scale) / 2, 0, Math.PI * 2);
            maskCtx.fill();
        }

        // Update last position
        lastImgX = imgX;
        lastImgY = imgY;

        draw();
    }

    function draw() {
        if (!ctx || !img) return;

        // 1. Clear with current background color
        if (bgColor === 'transparent') {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        } else {
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        const tempC = document.createElement('canvas');
        tempC.width = img.width;
        tempC.height = img.height;
        const tCtx = tempC.getContext('2d');
        tCtx.drawImage(img, 0, 0);
        tCtx.globalCompositeOperation = 'destination-out';
        tCtx.drawImage(maskCanvas, 0, 0);

        const drawW = img.width * scale;
        const drawH = img.height * scale;

        ctx.globalCompositeOperation = 'source-over';
        ctx.drawImage(tempC, posX, posY, drawW, drawH);

        // Draw Name & Date Slate if enabled
        drawNameDateSlate(ctx, canvas);

        updateFileSize();
    }
    async function getFinalImageData(exportScale = 1.0, quality = 0.95) {
        // Creates a merged version of high-res background + fabric layers
        const finalCanvas = document.createElement('canvas');
        finalCanvas.width = canvas.width * exportScale;
        finalCanvas.height = canvas.height * exportScale;
        const fCtx = finalCanvas.getContext('2d');

        // 1. Draw the high-res processed photo (from hidden canvas multiplied by scale)
        if (bgColor !== 'transparent') {
            fCtx.fillStyle = bgColor;
            fCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
        }

        const tempC = document.createElement('canvas');
        tempC.width = img.width;
        tempC.height = img.height;
        const tCtx = tempC.getContext('2d');
        tCtx.drawImage(img, 0, 0);
        tCtx.globalCompositeOperation = 'destination-out';
        tCtx.drawImage(maskCanvas, 0, 0);

        fCtx.drawImage(tempC, posX * exportScale, posY * exportScale, (img.width * scale) * exportScale, (img.height * scale) * exportScale);

        // Draw Name & Date Slate on Final Export
        drawNameDateSlate(fCtx, finalCanvas);

        // 2. Draw Fabric Layers on top
        if (fabricCanvas) {
            // Get all objects except background
            const objects = fabricCanvas.getObjects();
            const tempFabric = document.createElement('canvas');
            tempFabric.width = finalCanvas.width;
            tempFabric.height = finalCanvas.height;

            // Create a temporary static fabric canvas for high-res export
            const staticCanvas = new fabric.StaticCanvas(tempFabric);

            for (const obj of objects) {
                const clone = await new Promise(resolve => obj.clone(resolve));
                // Scale object to match export resolution
                const ratio = finalCanvas.width / fabricCanvas.width;
                clone.scaleX *= ratio;
                clone.scaleY *= ratio;
                clone.left *= ratio;
                clone.top *= ratio;
                staticCanvas.add(clone);
            }

            staticCanvas.renderAll();
            fCtx.drawImage(tempFabric, 0, 0);
            staticCanvas.dispose();
        }

        return finalCanvas.toDataURL('image/' + currentFormat, quality);
    }

    let fileSizeTimeout;
    function updateFileSize() {
        clearTimeout(fileSizeTimeout);
        fileSizeTimeout = setTimeout(() => {
            if (!canvas) return;
            const dataUrl = canvas.toDataURL('image/' + currentFormat, 0.95);
            const sizeInBytes = Math.round((dataUrl.length - ('data:image/' + currentFormat + ';base64,').length) * 3 / 4);
            const sizeInKb = (sizeInBytes / 1024).toFixed(1);
            const display = document.getElementById('file-size-display');
            if (display) display.innerText = `${sizeInKb} KB`;
        }, 500);
    }

    async function downloadFinal(event) {
        if (!canvas) return;

        const targetKb = parseInt(document.getElementById('target-kb').value) || 350;
        const targetBytes = targetKb * 1024;

        const btn = event?.currentTarget || document.querySelector('button[onclick^="downloadFinal"]');
        if (!btn) return;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.style.opacity = "0.7";
        btn.innerHTML = '<i class="fas fa-magic fa-spin text-lg"></i> AI High-Res Scaling...';

        try {
            // Feature 2: Blocker - Do NOT allow upscaling if original is too small
            let exportResScale = 1.0;
            if (img.width < 400 || img.height < 400) {
                console.log("Blocking upscaling due to low resolution.");
                exportResScale = 1.0;
                // In a real high-res logic, we'd have a multiplier here. 
                // Setting it to 1.0 blocks any AI-enhancement multipliers.
            }

            // Adaptive scaling
            let finalDataUrl = await getFinalImageData(exportResScale, 0.98);

            // For target size, we could loop getFinalImageData with different scales/qualities
            // but for now, we'll use the basic export to ensure the layers are merged correctly.

            const userFilename = document.getElementById('save-filename').value.trim().replace(/[^a-z0-9_\-]/gi, '_') || 'passport_photo';
            const link = document.createElement('a');
            link.download = `${userFilename}.${currentFormat === 'jpeg' ? 'jpg' : currentFormat}`;
            link.href = finalDataUrl;
            link.click();
        } catch (e) {
            console.error("Download error:", e);
            alert("Error during processing.");
        } finally {
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.innerHTML = originalHtml;
        }
    }

    // --- Name & Date Slate Logic ---
    function toggleSlate() {
        const enabled = document.getElementById('enable-slate').checked;
        const inputs = document.getElementById('slate-inputs');
        if (enabled) {
            inputs.classList.remove('hidden');
            // Set default date to today if empty
            const dateInput = document.getElementById('slate-date');
            if (!dateInput.value) {
                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const yyyy = today.getFullYear();
                dateInput.value = dd + '/' + mm + '/' + yyyy;
            }
        } else {
            inputs.classList.add('hidden');
        }
        draw();
    }

    function drawNameDateSlate(targetCtx, targetCanvas) {
        const enabled = document.getElementById('enable-slate').checked;
        if (!enabled) return;

        const name = document.getElementById('slate-name').value.toUpperCase();
        const date = document.getElementById('slate-date').value;

        const slateHeight = targetCanvas.height * 0.15; // Bottom 15%
        const slateY = targetCanvas.height - slateHeight;

        // Draw White Background Strip
        targetCtx.fillStyle = '#FFFFFF';
        targetCtx.fillRect(0, slateY, targetCanvas.width, slateHeight);

        // Draw Border
        targetCtx.strokeStyle = '#000000';
        targetCtx.lineWidth = Math.max(1, targetCanvas.width * 0.005);
        targetCtx.strokeRect(0, slateY, targetCanvas.width, slateHeight);

        // Text settings
        targetCtx.fillStyle = '#000000';
        targetCtx.textAlign = 'center';
        targetCtx.textBaseline = 'middle';

        // Responsive Font Size
        const fontSize = Math.floor(slateHeight * 0.35);
        targetCtx.font = `bold ${fontSize}px Arial, sans-serif`;

        // Draw Name
        targetCtx.fillText(name, targetCanvas.width / 2, slateY + (slateHeight * 0.35));

        // Draw Date
        targetCtx.font = `bold ${Math.floor(fontSize * 0.8)}px Arial, sans-serif`;
        targetCtx.fillText('DOA: ' + date, targetCanvas.width / 2, slateY + (slateHeight * 0.75));
    }
</script>
{% endblock %}